# Template file for 'Logseq'
pkgname=Logseq
version=0.10.9
revision=1
archs="x86_64"
hostmakedepends="nodejs yarn clojure python3 git"
makedepends="python3-setuptools openjdk17"
short_desc="Open-source platform for knowledge sharing and management"
maintainer="Viachaslau Ravinski <shnapsx@gmail.com>"
license="AGPL-3.0-only"
homepage="https://github.com/logseq/logseq"
distfiles="https://github.com/logseq/logseq/archive/refs/tags/${version}.tar.gz"
checksum=9fe98bbeb4355c1ad3ea5b3776f02455ee86b8157f74dd53bb9b3367df31403a
nostrip_files="Logseq"

do_configure() {
	# download required js modules
	yarn install

	# create and sync files to folder `static`
	yarn gulp:build

	# go to folder `static` and download required js modules in static
	cd "static"
	yarn install

	# go back to the top-level folder and download clojure dependencies
	cd "${XBPS_BUILDDIR}/${pkgname}-${version}"
	clojure -P -M:cljs
}

do_build() {
	source /etc/profile.d/jdk.sh
	cd "${XBPS_BUILDDIR}/${pkgname}-${version}"
	yarn cljs:release
	cd "static"
	yarn electron-forge package
}

do_install() {
	vinstall "${FILESDIR}/Logseq.desktop" 644 usr/share/applications
	vinstall "static/icons/logseq.png" 644 usr/share/pixmaps logseq.png
	vcopy "static/out/Logseq-linux-x64/" usr/lib/Logseq
	vlicense "static/out/Logseq-linux-x64/LICENSE"
	vlicense "static/out/Logseq-linux-x64/LICENSES.chromium.html"
	vbin "${FILESDIR}/Logseq.sh" Logseq
}
